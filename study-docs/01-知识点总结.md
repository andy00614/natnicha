# WildVoice 项目学习知识点总结

## 📅 学习日期
2025年10月5日

---

## 📚 核心技术栈

### 1. Next.js 15 (App Router)
- **项目结构**
  - `src/app/` - App Router 页面和 API
  - `src/app/api/` - API Routes
  - `src/components/` - 共享组件
  - `src/lib/` - 工具函数
  - `src/modules/` - 功能模块

- **API Routes 基础**
  ```typescript
  // src/app/api/example/route.ts
  export async function GET(request: Request) {
    return new Response(JSON.stringify({ data: "hello" }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  export async function POST(request: Request) {
    const body = await request.json();
    return new Response(JSON.stringify({ success: true }));
  }
  ```

- **动态路由**
  ```typescript
  // src/app/api/audio/[key]/route.ts
  export async function GET(
    request: Request,
    { params }: { params: { key: string } }
  ) {
    const key = params.key;
    // 处理逻辑
  }
  ```

---

### 2. Drizzle ORM (数据库)

#### **Schema 定义**
```typescript
import { integer, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const voicesSchema = sqliteTable("voices", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  userId: text("user_id").references(() => user.id, { onDelete: "cascade" }),
  createdAt: integer("created_at", { mode: "timestamp" }).defaultNow().notNull(),
});
```

#### **关键概念**
- **字段类型**: `text()`, `integer()`, `integer({ mode: "boolean" })`, `integer({ mode: "timestamp" })`
- **约束**: `.notNull()`, `.primaryKey()`, `.default()`, `.unique()`
- **外键**: `.references(() => 其他表.id, { onDelete: "cascade" })`
- **自动时间**: `.defaultNow()`, `.$onUpdate(() => new Date())`

#### **Zod 验证集成**
```typescript
import { createInsertSchema, createSelectSchema } from "drizzle-zod";
import { z } from "zod";

export const insertVoiceSchema = createInsertSchema(voicesSchema, {
  name: z.string().min(1, "名称不能为空").max(100, "名称过长"),
  rating: z.number().min(0).max(5).optional(),
});

export type Voice = typeof voicesSchema.$inferSelect;
export type NewVoice = typeof voicesSchema.$inferInsert;
```

#### **数据库操作**
```typescript
import { getDb } from "@/db";
import { eq, or } from "drizzle-orm";

const db = await getDb();

// 查询
const voices = await db.select().from(voicesSchema).where(
  eq(voicesSchema.userId, userId)
);

// 插入
const [newVoice] = await db.insert(voicesSchema).values({
  name: "Trump",
  userId: "123"
}).returning();

// 更新
await db.update(voicesSchema).set({ name: "New Name" }).where(
  eq(voicesSchema.id, 1)
);

// 删除
await db.delete(voicesSchema).where(eq(voicesSchema.id, 1));
```

#### **Migration 工作流**
```bash
# 1. 生成 migration
pnpm db:generate

# 2. 应用到本地
pnpm db:migrate:local

# 3. 应用到生产
pnpm db:migrate:prod

# 4. 查看数据库
pnpm db:studio
```

---

### 3. Cloudflare Workers & R2

#### **获取环境变量**
```typescript
import { getCloudflareContext } from "@opennextjs/cloudflare";

const { env } = await getCloudflareContext();
const apiKey = env.FAL_KEY;
const db = env.DB;
const r2 = env.FILES;
```

#### **R2 文件上传**
```typescript
// 上传文件
await env.FILES.put(key, arrayBuffer, {
  httpMetadata: {
    contentType: file.type,
    cacheControl: "public, max-age=31536000",
  },
  customMetadata: {
    originalName: file.name,
    uploadedAt: new Date().toISOString(),
  }
});

// 读取文件
const object = await env.FILES.get(key);
const arrayBuffer = await object.arrayBuffer();
```

#### **Remote Bindings (本地开发)**
```typescript
// next.config.ts
initOpenNextCloudflareForDev({
  experimental: {
    remoteBindings: true, // 本地连接真实 R2
  }
});
```

```jsonc
// wrangler.jsonc
{
  "r2_buckets": [
    {
      "bucket_name": "wild-voice-files",
      "binding": "FILES",
      "experimental_remote": true
    }
  ]
}
```

---

### 4. AI SDK (Vercel)

#### **配置 Provider**
```typescript
import { createFal } from "@ai-sdk/fal";

const fal = createFal({
  apiKey: env.FAL_KEY
});
```

#### **Text-to-Speech**
```typescript
import { experimental_generateSpeech as generateSpeech } from 'ai';

const { audio } = await generateSpeech({
  model: fal.speech('fal-ai/minimax/speech-02-hd'),
  text: 'Hello, world!',
  providerOptions: {
    fal: {
      voice_setting: {
        voice_id: "Wise_Woman",
        speed: 1.0,
        vol: 1.0,
        pitch: 0,
        emotion: "happy"
      }
    }
  }
});

// 处理音频数据
const audioBuffer = Buffer.from(audio.uint8Array);
```

#### **为什么选择 AI SDK？**
- ✅ 统一接口，易于切换提供商
- ✅ TypeScript 类型安全
- ✅ 支持多个 AI 提供商（FAL, OpenAI, ElevenLabs 等）
- ✅ 通过 `providerOptions` 访问高级参数

---

### 5. API 设计模式

#### **统一响应格式**
```typescript
// src/lib/api-response.ts
export interface ApiResponse<T = any> {
  success: boolean;
  data: T | null;
  error: string | null;
  message?: string;
}

export function successResponse<T>(data: T, message?: string, status = 200) {
  return new Response(JSON.stringify({
    success: true,
    data,
    error: null,
    message
  }), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
}

export function errorResponse(error: string, status = 400) {
  return new Response(JSON.stringify({
    success: false,
    data: null,
    error
  }), { status, headers: { 'Content-Type': 'application/json' } });
}
```

#### **错误处理**
```typescript
// src/lib/api-error.ts
export default function handleApiError(error: unknown) {
  if (error instanceof z.ZodError) {
    const firstError = error.issues[0];
    return new Response(JSON.stringify({
      success: false,
      error: firstError.message,
      field: firstError.path.join(".")
    }), { status: 400 });
  }

  const message = error instanceof Error ? error.message : "Internal server error";
  return new Response(JSON.stringify({
    success: false,
    error: message
  }), { status: 500 });
}
```

#### **认证中间件**
```typescript
const session = await getSession();
if (!session?.user) {
  return unauthorizedResponse();
}
```

---

### 6. 模块化架构

#### **功能模块结构**
```
src/modules/
├── voices/
│   └── schemas/
│       └── voice.schema.ts
├── outputs/
│   └── schemas/
│       └── output.schema.ts
└── auth/
    └── schemas/
        └── auth.schema.ts
```

#### **Schema 导出管理**
```typescript
// src/db/schema.ts
export { voicesSchema } from "@/modules/voices/schemas/voice.schema";
export { outputsSchema } from "@/modules/outputs/schemas/output.schema";
export { user, session } from "@/modules/auth/schemas/auth.schema";
```

---

### 7. 开发工具

#### **REST Client (.http 文件)**
```http
@baseUrl = http://localhost:3000
@sessionToken = your_session_token

### 测试 GET
GET {{baseUrl}}/api/voices
Cookie: better-auth.session_token={{sessionToken}}

### 测试 POST
POST {{baseUrl}}/api/tts
Cookie: better-auth.session_token={{sessionToken}}
Content-Type: application/json

{
  "text": "Hello",
  "voiceId": 1
}
```

---

## 🎯 核心学习要点

### 1. **Schema 设计原则**
- 使用有意义的字段名（camelCase）
- 外键关联要设置 `onDelete` 行为
- 时间戳使用 `mode: "timestamp"` 和 `.defaultNow()`
- 必填字段用 `.notNull()`，可选字段不加

### 2. **API 最佳实践**
- 统一响应格式
- 完整的错误处理
- 认证检查放在最前面
- 数据验证使用 Zod
- 返回正确的 HTTP 状态码（200, 201, 400, 401, 404, 500）

### 3. **类型安全**
- 使用 Drizzle 的类型推断：`$inferSelect`, `$inferInsert`
- Zod schema 自动生成：`createInsertSchema`, `createSelectSchema`
- TypeScript 类型导出：`export type Voice = typeof voicesSchema.$inferSelect`

### 4. **文件处理**
- `Uint8Array` → `Buffer.from()` → `Response`
- R2 上传使用 `File` 或 `ArrayBuffer`
- 设置正确的 `Content-Type` 和 `Content-Disposition`

### 5. **环境管理**
- 本地开发：`.dev.vars` + Remote Bindings
- 生产环境：`wrangler secret put`
- 通过 `getCloudflareContext()` 访问环境变量

---

## 🚀 实现的完整功能

### Voice Library (语音库)
- ✅ 数据库表设计
- ✅ GET /api/voices - 获取列表
- ✅ POST /api/voices - 创建声音
- ✅ 公共/私有权限控制

### Text-to-Speech (文字转语音)
- ✅ AI SDK + FAL 集成
- ✅ 支持自定义参数（speed, pitch, emotion）
- ✅ R2 存储
- ✅ 数据库记录
- ✅ 返回可访问的音频 URL

### Outputs (生成记录)
- ✅ 数据库表设计
- ✅ 保存 TTS 记录
- ✅ 关联用户和语音

---

## 💡 解决的技术难点

1. **AI SDK 在 Cloudflare Workers 中使用环境变量**
   - 问题：AI SDK 默认从 `process.env` 读取
   - 解决：使用 `createFal({ apiKey: env.FAL_KEY })`

2. **本地 R2 开发无公共 URL**
   - 问题：本地 R2 是模拟的，无法生成公共 URL
   - 解决：启用 Remote Bindings，直接连接真实 R2

3. **音频数据类型转换**
   - 问题：`GeneratedAudioFile` 不能直接传给 `Response`
   - 解决：`Buffer.from(audio.uint8Array)`

4. **数据验证与类型安全**
   - 问题：需要运行时验证和编译时类型检查
   - 解决：Drizzle + Zod 结合，自动生成验证 schema

---

## 📖 推荐延伸学习

1. **Drizzle ORM 高级查询**
   - Joins
   - Transactions
   - Prepared Statements

2. **AI SDK 其他功能**
   - `streamText` - 流式文本生成
   - `generateObject` - 结构化数据生成
   - Tool Calling

3. **Cloudflare Workers**
   - Durable Objects
   - KV Storage
   - Queues

4. **Next.js 15 新特性**
   - Server Actions
   - Partial Prerendering
   - Turbopack

---

_生成时间: 2025-10-05_
